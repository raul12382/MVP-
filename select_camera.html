<!DOCTYPE html>
<!--
 *  Copyright (c) 2015 The WebRTC project authors. All Rights Reserved.
 *
 *  Use of this source code is governed by a BSD-style license
 *  that can be found in the LICENSE file in the root of the source
 *  tree.
-->
<html>
<head>

    <meta charset="utf-8">
    <meta name="description" content="WebRTC code samples">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="mobile-web-app-capable" content="yes">
    <meta id="theme-color" name="theme-color" content="#ffffff">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/UAParser.js/0.7.28/ua-parser.min.js"></script>
    <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


    <title>Select video sources</title>
    <link href="//fonts.googleapis.com/css?family=Roboto:300,400,500,700" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="css/main.css">
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css"
      integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l"
      crossorigin="anonymous"
    />
    <style>
        div.select {
            display: inline-block;
            margin: 0 0 1em 0;
        }

        p.small {
            font-size: 0.7em;
        }

        label {
            width: 12em;
            display: inline-block;
        }
    </style>

<script>

    function getText(id){
        var node = document.getElementById(id);
        var text  = node.textContent || node.innerText;
        return text
    }
    function saveStaticDataToFile(){
        var height = video.videoHeight
        var width  = video.videoWidth
        console.log("camara" +height)
        const img = document.getElementById('imagen')
        const estado = document.getElementById('estado')
        canvas = document.getElementById('canvas');
        canvas.setAttribute('width', width);
        canvas.setAttribute('height', height);

        canvas.getContext('2d').drawImage(video, 0, 0, width, height);
        var data = canvas.toDataURL('image/jpg');                   
        var textToWrite = getText("selected")+"\r\n" + getText("index") + "\r\n" + getText("model") + "\r\n" + data;
        console.log("aqui la imagen" + data)

        //const imagen = document.getElementById('image')
        //imagen.element.innerHTML = `<img src=${data}/>`
        /* var blob = new Blob([textToWrite],
            { type: "text/plain;charset=utf-8" });
        saveAs(blob, "log.txt"); */
        const json = {
            imagen :data,
            index: getText("selected"),
            model: getText("model") 
        }
        console.log("aqui el json"+json)
        //img.innerHTML = `<img src=${data}>`
        Swal.fire({
            title: '¡Captura realizada con exito!',
            text: '¿Desea enviar la información?',
            imageUrl: data,
            imageWidth: 300,
            imageHeight: 250,
            imageAlt: 'Custom image',
            confirmButtonText: 'Enviar data',
            showCancelButton: true,
            denyButtonText: `Elegir otra camara`,
            denyButtonColor: '#3085d6',
            showDenyButton: true,
        }).then((result)=>{
            if (result.isConfirmed){
                localStorage.setItem("index", getText("index"))
                localStorage.setItem("selected", getText("selected"))
                document.cookie =`"index=${getText("index")};  expires=Thu, 31 Dec 2022 12:00:00 UTC;"`
                document.cookie =`"camera=${getText("selected")};  expires=Thu, 31 Dec 2022 12:00:00 UTC;"`
                document.getElementById('loader').hidden = false
                document.getElementById('estado').hidden = true
                document.getElementById('captura').hidden = true
               // document.getElementById('estado').element.innerHTML = 'enviando data'
                fetch("https://webhook.site/674b1498-ed7b-4ef4-a12b-c3e97932cc41", {
                            method: "POST",
                            body: JSON.stringify(json),
                            mode: "no-cors",
                            headers: {
                                "Content-type": "application/json",
                            }
                        })
                        .then(resultado => {
                            document.getElementById('loader').hidden = true
                            estado.hidden = true
                            Swal.fire({
                                icon: 'success',
                                title: 'Excelente!',
                                text: 'Data enviada con exito',
                                confirmButtonText: `OK`,
                                })/* .then((result)=>{
                                        if (result.isConfirmed){
                                        location.href = 'index.html'
                                        }
                                }) */
                                setTimeout(function(){location.href ='index.html'}, 1200) 
                            // if(resultado.data == "200"){
                                
                            // }else{
                            //     Swal.fire({
                            //     icon: 'error',
                            //     title: 'Upps..',
                            //     text: 'Ah ocurrido un error, intente de nuevo',
                            //     confirmButtonText: `OK`,
                            //     }).then((result)=>{
                            //             if (result.isConfirmed){
                            //             location.href = 'instrucciones.html'
                            //             }
                            //     })
                            // }                            
                        })
            }else if(result.isDenied){
              cambiarCamera()
            }
        })
     

        /* fetch("https://webhook.site/674b1498-ed7b-4ef4-a12b-c3e97932cc41", {
                            method: "POST",
                            body: JSON.stringify(json),
                            mode: "no-cors",
                            headers: {
                                "Content-type": "application/json",
                            }
                        })
                        .then(resultado => {
                            // A los datos los decodificamos como texto plano
                            estado.innerHTML = "Foto guardada con éxito"
                            document.getElementById('video').hidden = true
                        }) */
        
    }
  function saveStaticDataToFile2(){
    let full = document.getElementById('captura')
    full.hidden = false
    document.getElementById('container').hidden = true
  }

  function cambiarCamera(){
    document.getElementById('canvas').hidden = true
              let full = document.getElementById('captura')
              full.hidden = true
              document.getElementById('container').hidden = false
  }
</script>

</head>

<body style="background-color: black;">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <a class="navbar-brand" href="index.html">
            <img src="https://signmeter.tocbiometrics.com/apimeter-sandbox/assets/img/logo-toc.png" width="80px" class="d-inline-block align-top" alt="">
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-toggle="collapse"
          data-target="#navbarTapeDark"
          aria-controls="navbarTapeDark"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarTapeDark">
          <ul class="navbar-nav mr-auto">
            <li class="nav-item active">
              <a class="nav-link" href="#"
                >Home <span class="sr-only">(current)</span></a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">Listado de moviles</a>
            </li>
          </ul>
        </div>
      </nav>
<div id="container" class="text-center p-5"  style="color:#00AFDC; font-family: Georgia, Serif;"> <!-- validar si tiene permiso de camara o no -->
    <h3 style="font-family: 'Raleway', sans-serif;">Seleccione la mejor camara para <span>Autocaptura</span>
    </h1>
    <hr>
    <div class="select">
        <label for="videoSource" style="color: white;">Seleccione la camara:</label><select class="select-cam" id="videoSource"></select>
    </div>

    <h4 style="color: white;">La camara seleccionada es: <span id="selected" style="color:#00AFDC;" translate="yes"> </span></h4>
    <h2 hidden="true">Indice: <span id="index"> </span></h2>
    <h2 hidden="true"> Modelo: <span id="model"> </span></h2> 
    <hr style="background-color: white;">
    <button type="button" class="btn btn-info btn-lg btn-block" id="tomafoto2" onclick="saveStaticDataToFile2();">Ir a capturar la cedula</button>

	<p id="estado"></p>
  <canvas id="canvas"></canvas>
</div>
<div id="captura"  hidden="true" class="text-center" >
    <video  id="video" playsinline autoplay></video>
    <button type="button" class="btn btn-info" id="tomafoto" onclick="saveStaticDataToFile();">Tomar fotografia</button>
    <button type="button" class="btn btn-info" onclick="cambiarCamera();">Cambiar camara</button>
</div>
<div style="color: azure; padding: 15; align-items: center;"  class="text-center" id="loader" hidden="true">
  <div class="spinner-border" role="status" >
    <span class="sr-only">Loading...</span>
  </div>
  <h2 >Enviando data...</h2>
</div>
</div>
<script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
<script src="js/main.js" async></script>
<script
      src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
      integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
      integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js"
      integrity="sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF"
      crossorigin="anonymous"
    ></script>
</body>
</html>
